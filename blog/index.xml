<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Bolívar Aponte Rolón</title>
<link>https://www.bolaponte.com/blog/</link>
<atom:link href="https://www.bolaponte.com/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>Divagations (yes, it&#39;s a word) at the intersection data, biology and code
</description>
<generator>quarto-1.5.57</generator>
<lastBuildDate>Mon, 11 Nov 2024 06:00:00 GMT</lastBuildDate>
<item>
  <title>Flexible R Setup on Linux</title>
  <dc:creator>Bolívar Aponte Rolón</dc:creator>
  <link>https://www.bolaponte.com/blog/2024-11-11-flexible_r/</link>
  <description><![CDATA[ 

<!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html -->
<!-- <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
-->
<!-- <header id="title-block-header" class="quarto-title-block default page-columns"> -->
<!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> -->



<p>Achieving reproducible results, whether working with full analytical pipelines or simple analyses, is contingent on the specific software used and the underlying environment. Often times, we need to reproduce experimental results or need to use packages that are no longer being maintained. With R, this is easily achieved through some combination of Conda virtual environments, <code>renv</code> and Docker images. This is often considered the epitome of reproducibility. However, sometimes it just doesn’t merit setting up a whole environment to work on a small project, therefore having multiple versions of R in the base environment might be desirable to speed things up. The process of setting up different R versions in the base environment, accessed through RStudio, depends on your operating system:</p>
<ul>
<li><strong>Windows</strong>:
<ul>
<li>Access <strong>RStudio’s Global Options</strong> to easily set your preferred binary version.</li>
</ul></li>
<li><strong>Mac</strong>:
<ul>
<li>You can install R in various ways with the most seamless method being <a href="https://rud.is/rswitch/">Rswitch</a>.</li>
</ul></li>
<li><strong>Additional Resources</strong>:
<ul>
<li>For installation details on Windows, Mac and Linux, check <a href="https://support.posit.co/hc/en-us/articles/200486138-Changing-R-versions-for-the-RStudio-Desktop-IDE">Posit’s support page</a>.</li>
<li>See <a href="https://www.monicathieu.com/posts/2024-05-21-multiple-r-versions/">Monica Thieu’s post</a> for further insights from the community on managing multiple R versions on Mac.</li>
</ul></li>
</ul>
<section id="how-to-install-and-switch-between-various-versions-of-r-in-a-linux-base-environment" class="level3">
<h3 class="anchored" data-anchor-id="how-to-install-and-switch-between-various-versions-of-r-in-a-linux-base-environment">How to install and switch between various versions of R in a Linux base environment?</h3>
<p>It quite straightforward but like many tasks on Linux, it requires a bit more forethought and understanding of the system. Posit also has a good <a href="https://support.posit.co/hc/en-us/articles/215488098-Installing-multiple-versions-of-R-on-Linux">support page</a> , but the seamless switching is only available in their Pro products. I decided to document how I did this on my local machine following Posit’s guides and the extensive documentation from the <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-admin.html">R Core Team</a>. Along the way, I also opted to install R with the OpenBLAS library, which provides optimizedBLAS (Basic Linear Algebra Subprograms) and LAPACK (Linear Algebra PACKage) libraries to improve performance. An alternative BLAS/LAPACK library is the <a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html">Intel oneAPI Base</a> that is apparently faster. Perhaps I will try that later following <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/using-onemkl-with-r.html">instructions from Intel.</a> For now, I’ll stick to OpenBLAS.</p>
<hr>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Transparency Notice
</div>
</div>
<div class="callout-body-container callout-body">
<p>To provide a polished and comprehensive overview, I utilized ChatGPT, an AI language model by OpenAI, for drafting and refining portions of this article.</p>
</div>
</div>
</section>
<section id="lets-get-into-it" class="level2">
<h2 class="anchored" data-anchor-id="lets-get-into-it">Let’s get into it</h2>
<p>We’ll install R from source with two different configurations and learn how to switch between versions. See the <a href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html#BLAS">R installation guide for more options.</a></p>
<ol type="1">
<li><p><strong>Internal BLAS</strong>: Uses R’s internal shared BLAS library (<code>libRblas.so</code>) for simplicity and modularity.</p></li>
<li><p><strong>OpenBLAS</strong>: Links R to system-optimized OpenBLAS and LAPACK libraries for performance gains.</p></li>
<li><p><strong>How to switch between R versions</strong>: Changing environment variables to choose our R versions.</p></li>
</ol>
<p>Both configurations include the shared R library (<code>libR.so</code>), which is important for compatibility with external applications like RStudio.</p>
<hr>
</section>
<section id="configuration-1-using-rs-internal-shared-blas-library" class="level2">
<h2 class="anchored" data-anchor-id="configuration-1-using-rs-internal-shared-blas-library">Configuration 1: Using R’s Internal Shared BLAS Library</h2>
<p>This configuration uses R’s internal BLAS library (<code>libRblas.so</code>) by building it as a shared library. It is straightforward and avoids external dependencies, ensuring compatibility across various setups. Although this configuration may lack some of the performance optimizations provided by OpenBLAS, it is ideal for general usage and stable builds.</p>
<hr>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<p>Install the necessary build dependencies:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> pacman <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-S</span> base-devel gcc-fortran blas lapack</span></code></pre></div>
<p>Download and extract the R source code from CRAN:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://cran.r-project.org/src/base/R-4/R-4.4.2.tar.gz  </span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tar</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-xzvf</span> R-4.4.2.tar.gz  </span>
<span id="cb2-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> R-4.4.2</span></code></pre></div>
<p><em>For this tutorial I installed R 4.4.1 and 4.4.2, which are not really that different but the same steps apply to any version.</em></p>
<hr>
</section>
<section id="configure" class="level3">
<h3 class="anchored" data-anchor-id="configure">Configure</h3>
<p>Run the following command to configure R with its internal shared BLAS:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./configure</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--prefix</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/opt/R/<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span> VERSION<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--enable-R-shlib</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--enable-BLAS-shlib</span></span></code></pre></div>
<section id="explanation-of-flags" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-flags">Explanation of Flags</h4>
<ul>
<li><strong><code>--prefix=/opt/R/$(cat VERSION)</code></strong>: Installs R in a versioned directory under <code>/opt/R</code>, allowing multiple R versions to coexist (e.g., <code>/opt/R/4.4.2</code>).</li>
<li><strong><code>--enable-R-shlib</code></strong>: Builds the shared R library <code>libR.so</code>, which is required for integration with RStudio.</li>
<li><strong><code>--enable-BLAS-shlib</code></strong>: Builds R’s internal BLAS library (<code>libRblas.so</code>) as a shared library.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>configure</code> script to build R from source has many more options. Be sure to check those out and tailor your installation to your needs.</p>
</div>
</div>
</section>
</section>
<section id="verification-after-.configure" class="level3">
<h3 class="anchored" data-anchor-id="verification-after-.configure">Verification after <code>./configure</code></h3>
<p>This is the last bit <code>.configure</code> outputs when finished:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> is now configured for x86_64-pc-linux-gnu  </span>
<span id="cb4-2">  </span>
<span id="cb4-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Source</span> directory: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.  </span>
<span id="cb4-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Installation</span> directory: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/opt/R/4.4.2  </span>
<span id="cb4-5">  </span>
<span id="cb4-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gcc &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Fortran</span> fixed-form compiler: gfortran &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-8">  </span>
<span id="cb4-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Default</span> C++ compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++17 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++11</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++11 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++14</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++14 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++17</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++17 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++20</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++20 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++23</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++23 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Fortran</span> free-form compiler: &nbsp;gfortran &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb4-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Obj-C</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb4-17">  </span>
<span id="cb4-18"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Interfaces</span> supported: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X11, tcltk  </span>
<span id="cb4-19"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;External</span> libraries: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcre2, readline, curl, libdeflate  </span>
<span id="cb4-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Additional</span> capabilities: &nbsp;&nbsp;&nbsp;&nbsp;PNG, JPEG, TIFF, NLS, cairo, ICU  </span>
<span id="cb4-21"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Options</span> enabled: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared R library, shared BLAS, R profiling, libdeflate for lazyload  </span>
<span id="cb4-22">  </span>
<span id="cb4-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Capabilities</span> skipped: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb4-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Options</span> not enabled: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memory profiling  </span>
<span id="cb4-25">  </span>
<span id="cb4-26"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Recommended</span> packages: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes</span></code></pre></div>
</section>
<section id="building-and-installing-r" class="level3">
<h3 class="anchored" data-anchor-id="building-and-installing-r">Building and Installing R</h3>
<p>Once configured, compile and install R:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-j</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nproc</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Setting to number cores to speed up a little bit</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> make install</span></code></pre></div>
<p>After installation, run the following to check R’s configuration:</p>
<p><code>R  sessionInfo()</code></p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> version 4.4.2 <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2024-10-31</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Platform:</span> x86_64-pc-linux-gnu</span>
<span id="cb6-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Running</span> under: Arch Linux</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">Matrix</span> products: default</span>
<span id="cb6-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">BLAS:</span>   /opt/R/4.4.2/lib64/R/lib/libRblas.so <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Built shared BLAS library</span></span>
<span id="cb6-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">LAPACK:</span> /usr/lib/liblapack.so.3.12.0 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># System LAPACK library</span></span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">locale:</span></span>
<span id="cb6-10"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[1]</span> LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8        LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8   </span>
<span id="cb6-11"> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[6]</span> LC_MESSAGES=C.UTF-8    LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C           LC_TELEPHONE=C        </span>
<span id="cb6-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[11]</span> LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span>
<span id="cb6-13"></span>
<span id="cb6-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">time</span> zone: America/Chicago</span>
<span id="cb6-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">tzcode</span> source: system <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">glibc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span></span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">attached</span> base packages:</span>
<span id="cb6-18"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[1]</span> stats     graphics  grDevices utils     datasets  methods   base     </span>
<span id="cb6-19"></span>
<span id="cb6-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">loaded</span> via a namespace <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">and</span> not attached<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">:</span></span>
<span id="cb6-21"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">[1]</span> compiler_4.4.2 tools_4.4.2</span></code></pre></div>
<p>I’ve used this install configuration for almost every data science project I’ve tackled. It is minimal and ready for general usage.</p>
<p><strong>What if we want better performance?</strong> Let’s set it up with OpenBLAS and get some speed. Checkout some of the benchmarks mentioned in this <a href="https://github.com/goepp/r-blas?tab=readme-ov-file">GitHub repo</a> , <a href="https://csantill.github.io/RPerformanceWBLAS/">here</a>, and also <a href="https://software.intel.com/content/www/us/en/develop/articles/performance-comparison-of-openblas-and-intel-math-kernel-library-in-r.html">here</a></p>
<div class="tenor-gif-embed" data-postid="12905629" data-share-method="host" data-aspect-ratio="1.75" data-width="100%">
<a href="https://tenor.com/view/speed-racer-go-time-race-gif-12905629">Speed Racer Go Time GIF</a>from <a href="https://tenor.com/search/speed+racer-gifs">Speed Racer GIFs</a>
</div>
<script type="text/javascript" async="" src="https://tenor.com/embed.js"></script>
</section>
</section>
<section id="configuration-2-linking-to-system-optimized-openblas-and-lapack" class="level2">
<h2 class="anchored" data-anchor-id="configuration-2-linking-to-system-optimized-openblas-and-lapack">Configuration 2: Linking to System-Optimized OpenBLAS and LAPACK</h2>
<p>Here, we want to link R to the system’s OpenBLAS and LAPACK libraries, which are optimized for performance and multi-threading. It is ideal for high-performance linear algebra operations. The way to achieve this is by explicitly requesting the libraries using the <code>--with-blas</code> and <code>--with-lapack</code>. Find more details in this <a href="https://colinfay.me/r-installation-administration/appendix-a-essential-and-useful-other-programs-under-a-unix-alike.html">old R installation guide</a> and the <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-admin.html#BLAS">upcoming R guide</a>.</p>
<section id="prerequisites-1" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites-1">Prerequisites</h3>
<p>Install the necessary build dependencies:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> pacman <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-S</span> base-devel gcc-fortran openblas lapack</span></code></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The main difference here is that we install <code>openblas</code>. It shouldn’t have any conflict with <code>blas</code>, if it does you might want to build from source in <code>/opt</code> as well.</p>
</div>
</div>
<p>Download and extract the R source code from CRAN:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://cran.r-project.org/src/base/R-4/R-4.4.2.tar.gz  </span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tar</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-xzvf</span> R-4.4.2.tar.gz  </span>
<span id="cb8-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> R-4.4.2</span></code></pre></div>
<p>We need to check where the BLAS and LAPACK library <em>symlinks</em> and executables are located:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ls</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-ld</span> /usr/lib/liblapack<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span> /usr/lib/libopenblas<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span></code></pre></div>
<p>I prefer to link the libraries by providing the absolute path. It is also possible to give a name without a path (like <code>-lfoo</code>) and the linker will look for a library file named <code>libfoo.so</code> (or <code>libfoo.a</code> for a static library) in standard library directories. See <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-admin.html#BLAS">BLAS configuration guide</a>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the executables<code>liblapack.so.*</code> and <code>libopenblas.so.*</code>. If you have color coding in your terminal it will be a slightly brighter green, see below.</p>
<p><a href="images/Pasted image 20241106083443.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://www.bolaponte.com/blog/2024-11-11-flexible_r/images/Pasted image 20241106083443.png" class="img-fluid"></a></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note on <code>blas-openblas</code> and 64-Bit Integer Library Support
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can link to the bundled BLAS and LAPACK libraries provided by <code>blas-openblas</code> using the <code>--with-blas</code> flag.</p>
<p><strong>Important:</strong> The <code>blas-openblas</code> library conflicts with <code>blas</code>. Since it provides BLAS/CBLAS/LAPACK/LAPACKE system-wide, any packages that depend on these libraries will need to be rebuilt. For this reason, building from source in a dedicated directory is recommended.</p>
<p>The <code>blas64-openblas</code> library does not create conflicts and can be particularly beneficial for handling large datasets or complex scientific computations. By supporting 64-bit indexing, <code>blas64-openblas</code> enables larger matrix operations, making it ideal for intensive data processing.</p>
</div>
</div>
</section>
<section id="installing-r-with-openblas" class="level3">
<h3 class="anchored" data-anchor-id="installing-r-with-openblas">Installing R with <code>openblas</code></h3>
<p>Run the following command to configure R with OpenBLAS and LAPACK:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">./configure</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--prefix</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>/opt/R/<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span> VERSION<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb10-2">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--enable-R-shlib</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb10-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--with-blas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/usr/lib/libopenblas.so.0.3"</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb10-4">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--with-lapack</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/usr/lib/liblapack.so.3.12.0"</span></span></code></pre></div>
<section id="flags-used" class="level4">
<h4 class="anchored" data-anchor-id="flags-used">Flags used</h4>
<ul>
<li><strong><code>--prefix=/opt/R/$(cat VERSION)</code></strong>: Installs R in a versioned directory under <code>/opt/R</code>, as in Configuration 1.</li>
<li><strong><code>--enable-R-shlib</code></strong>: Builds <code>libR.so</code>, the shared R library.</li>
<li><strong><code>--with-blas="/usr/lib/libopenblas.so.0.3"</code></strong>: Links R to the system’s OpenBLAS library for optimized BLAS routines.</li>
<li><strong><code>--with-lapack="/usr/lib/liblapack.so.3.12.0"</code></strong>: Links R to the system’s LAPACK library, providing optimized higher-level matrix operations.</li>
</ul>
</section>
<section id="configuration-output" class="level4">
<h4 class="anchored" data-anchor-id="configuration-output">Configuration output</h4>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">R</span> is now configured for x86_64-pc-linux-gnu  </span>
<span id="cb11-2">  </span>
<span id="cb11-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Source</span> directory: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.  </span>
<span id="cb11-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Installation</span> directory: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/opt/R/4.4.2  </span>
<span id="cb11-5">  </span>
<span id="cb11-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gcc &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Fortran</span> fixed-form compiler: gfortran &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-8">  </span>
<span id="cb11-9"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Default</span> C++ compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++17 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++11</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++11 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++14</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++14 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-12"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++17</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++17 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-13"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++20</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++20 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-14"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;C++23</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g++ <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-std</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gnu++23 &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-15"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Fortran</span> free-form compiler: &nbsp;gfortran &nbsp;-g <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O2</span>  </span>
<span id="cb11-16"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Obj-C</span> compiler: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb11-17">  </span>
<span id="cb11-18"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Interfaces</span> supported: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X11, tcltk  </span>
<span id="cb11-19"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;External</span> libraries: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pcre2, readline, BLAS<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">generic</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> LAPACK<span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">generic</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">,</span> curl, libdeflate  </span>
<span id="cb11-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Additional</span> capabilities: &nbsp;&nbsp;&nbsp;&nbsp;PNG, JPEG, TIFF, NLS, cairo, ICU  </span>
<span id="cb11-21"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Options</span> enabled: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared R library, R profiling, libdeflate for lazyload  </span>
<span id="cb11-22">  </span>
<span id="cb11-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Capabilities</span> skipped: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb11-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Options</span> not enabled: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared BLAS, memory profiling  </span>
<span id="cb11-25">  </span>
<span id="cb11-26"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">&nbsp;Recommended</span> packages: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yes</span></code></pre></div>
<p><em>Notice <code>BLAS(generic), LAPACK(generic)</code>, indicating the use of the system’s libraries.</em></p>
</section>
<section id="building-and-installing-r-1" class="level4">
<h4 class="anchored" data-anchor-id="building-and-installing-r-1">Building and installing R</h4>
<p>Once configured with the above command, compile and install R:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-j</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nproc</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span> </span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> make install</span></code></pre></div>
<p>Like before, we run the following to check R’s configuration:</p>
<p><code>R sessionInfo()</code></p>
<p>Your output should look like this:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">R version <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>.<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.2</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024-10-31</span>)  </span>
<span id="cb13-2">Platform<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x86_64<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>linux<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gnu  </span>
<span id="cb13-3">Running under<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> Arch Linux  </span>
<span id="cb13-4">  </span>
<span id="cb13-5">Matrix products<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> default  </span>
<span id="cb13-6">BLAS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>LAPACK<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span>usr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lib<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>libopenblas.so.<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>; &nbsp;LAPACK version <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>.<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.0</span>  </span>
<span id="cb13-7">  </span>
<span id="cb13-8">locale<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>  </span>
<span id="cb13-9">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] LC_CTYPE<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_NUMERIC<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_TIME<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb13-10">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] LC_COLLATE<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;&nbsp;LC_MONETARY<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;LC_MESSAGES<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;  </span>
<span id="cb13-11">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>] LC_PAPER<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_NAME<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_ADDRESS<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb13-12">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>] LC_TELEPHONE<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_MEASUREMENT<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C.UTF<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-8</span> LC_IDENTIFICATION<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>C &nbsp;&nbsp;&nbsp;  </span>
<span id="cb13-13">  </span>
<span id="cb13-14">time zone<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> America<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Chicago  </span>
<span id="cb13-15">tzcode source<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system</span> (glibc)  </span>
<span id="cb13-16">  </span>
<span id="cb13-17">attached base packages<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>  </span>
<span id="cb13-18">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] stats &nbsp;&nbsp;&nbsp;&nbsp;graphics &nbsp;grDevices utils &nbsp;&nbsp;&nbsp;&nbsp;datasets &nbsp;methods &nbsp;&nbsp;base &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </span>
<span id="cb13-19">  </span>
<span id="cb13-20">loaded via a <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">namespace</span> (and not attached)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>  </span>
<span id="cb13-21">[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] compiler_4.<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.</span></span></code></pre></div>
<p>Notice the linked <code>openblas</code> library in BLAS/LAPACK , in comparison to when we use <code>--enable-BLAS-shlib</code> only. OpenBLAS typically includes LAPACK routines as part of the library, so R is effectively using the LAPACK routines within OpenBLAS, which is compatible with LAPACK version 3.12.0.</p>
</section>
</section>
</section>
<section id="benefits-of-using-system-optimized-blaslapack" class="level2">
<h2 class="anchored" data-anchor-id="benefits-of-using-system-optimized-blaslapack">Benefits of Using System-Optimized BLAS/LAPACK</h2>
<p>By linking R to system-provided OpenBLAS and LAPACK libraries, we improved performance in numerical operations. Well, I haven’t performed a benchmark of my own but I trust that it is a little faster. We should expect:</p>
<ol type="1">
<li><strong>Performance Gains</strong>:
<ul>
<li><a href="https://www.openblas.net/"><strong>OpenBLAS</strong></a> is highly optimized for operations such as matrix multiplications, dot products, and other foundational linear algebra tasks. It can significantly speed up computations in R, especially for functions that rely heavily on these operations (e.g., matrix decompositions, linear regression, and large-scale simulations).</li>
<li><strong>LAPACK</strong> complements BLAS by providing higher-level mathematical functions, such as eigenvalue decompositions, singular value decompositions (SVD), and other advanced matrix operations. LAPACK routines calls BLAS to perform complex computations, thus reducing computation time for common data science, statistical modeling, and machine learning operations.</li>
</ul></li>
<li><strong>Multi-threading Support</strong>:
<ul>
<li>OpenBLAS is designed to take advantage of multi-core CPUs, (with some <a href="https://github.com/OpenMathLib/OpenBLAS/wiki/Faq#after-making-openblas-i-find-that-the-static-library-is-multithreaded-but-the-dynamic-one-is-not-">caveats</a>), making it ideal for computations that benefit from parallel processing. By linking R to OpenBLAS, R can automatically utilize multiple cores for matrix and linear algebra computations, significantly reducing computation times on multi-threaded operations.</li>
</ul></li>
<li><strong>Architecture-Specific Optimizations</strong>:
<ul>
<li>OpenBLAS and LAPACK are frequently optimized for specific CPU architectures (e.g., Intel, AMD) and can take advantage of processor-specific instructions like Advanced Vector Extensions (AVX) and Streaming SIMD Extensions (SSE). This means that R can achieve better performance on compatible hardware, albeit contingent on the underlying architecture, compared to using its internal BLAS/LAPACK libraries.</li>
</ul></li>
</ol>
<p>We could conduct benchmarks to measure how much computation time has improved, but that’s beyond our scope for now. To compare different R versions, I need to switch between them. So, how do we go about doing that?</p>
</section>
<section id="how-to-switch-between-r-versions" class="level2">
<h2 class="anchored" data-anchor-id="how-to-switch-between-r-versions">How to switch between R versions</h2>
<p>All that effort is impressive but it loses its value if it comes with friction. On Windows and Mac, toggling between R versions is straightforward, as I mentioned earlier. However, Linux users often face more challenges. Fortunately, the community has developed several solutions to streamline this process.</p>
<p>I found a nifty shim written by Jeff Keller to <a href="https://jeff.vtkellers.com/posts/data-science/managing-multiple-r-installations-on-linux/">toggle between R versions</a>. It’s a shell script to set the environment variable <code>R_VERSION</code> to the preferred version and then launch R Studio.</p>
<p>I echo his script here with some modifications of my own.</p>
</section>
<section id="toggle-shim" class="level2">
<h2 class="anchored" data-anchor-id="toggle-shim">Toggle Shim</h2>
<p>As a <code>root</code>, replace the <code>R</code> and <code>Rscript</code> binaries found in <code>/bin/R/</code> and /<code>bin/Rscript</code>.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt; 'EOF'</span>  /bin/R</span>
<span id="cb14-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#!/bin/bash</span></span>
<span id="cb14-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">&lt;&lt;prelude</span></span>
<span id="cb14-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Shim from https://jeff.vtkellers.com/posts/data-science/managing-multiple-r-installations-on-linux/</span></span>
<span id="cb14-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">used to toggle between R versions installed in /opt/R</span></span>
<span id="cb14-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">prelude</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Uncomment this to set a fixed default version of R. Otherwise, the</span></span>
<span id="cb14-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># most recent version will be used.</span></span>
<span id="cb14-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">R_VERSION_DEFAULT="4.4.1"</span></span>
<span id="cb14-11"></span>
<span id="cb14-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># The default installation directory is /opt/R (https://docs.rstudio.com/resources/install-r/)</span></span>
<span id="cb14-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Change this as is necessary for your environment.</span></span>
<span id="cb14-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">R_INSTALL_DIR="/opt/R"</span></span>
<span id="cb14-15"></span>
<span id="cb14-16"></span>
<span id="cb14-17"></span>
<span id="cb14-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">R_VERSIONS_AVAIL=($(basename --multiple $(dirname $(dirname $(ls "${R_INSTALL_DIR}"/*/bin/R))) | sort --version-sort))</span></span>
<span id="cb14-19"></span>
<span id="cb14-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># If no default R version is set then set the most recent version as the default</span></span>
<span id="cb14-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">if [ -z ${R_VERSION_DEFAULT} ]; then</span></span>
<span id="cb14-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R_VERSION_DEFAULT="${R_VERSIONS_AVAIL[-1]}"</span></span>
<span id="cb14-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">fi</span></span>
<span id="cb14-24"></span>
<span id="cb14-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># If a specific R version was not requested then use the default</span></span>
<span id="cb14-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">if [ -z ${R_VERSION} ]; then</span></span>
<span id="cb14-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R_VERSION="${R_VERSION_DEFAULT}"</span></span>
<span id="cb14-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">fi</span></span>
<span id="cb14-29"></span>
<span id="cb14-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">R_BINARY_BASE=$(basename $0)</span></span>
<span id="cb14-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">R_BINARY="${R_INSTALL_DIR}/${R_VERSION}/bin/${R_BINARY_BASE}"</span></span>
<span id="cb14-32"></span>
<span id="cb14-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">if [ ! -f $R_BINARY ]; then</span></span>
<span id="cb14-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  echo "${R_BINARY_BASE} ${R_VERSION} not found. Available versions: ${R_VERSIONS_AVAIL[*]}"</span></span>
<span id="cb14-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  exit 1</span></span>
<span id="cb14-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">fi</span></span>
<span id="cb14-37"></span>
<span id="cb14-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"># Unset the R_HOME env var if something else set it</span></span>
<span id="cb14-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">unset R_HOME</span></span>
<span id="cb14-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"${R_BINARY}" "$@"</span></span>
<span id="cb14-41"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">EOF</span></span></code></pre></div>
<p>Changing <code>/bin/R/</code> should result in changes in <code>/usr/bin/R</code>. You can double check before proceeding. I fixed my default version of R but you can comment to set to the latest R version.</p>
<p>Make the script executable:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> +x /bin/R</span></code></pre></div>
<p>Create a Symlink to <code>Rscript</code></p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ln</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/R /bin/Rscript</span></code></pre></div>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">Usage</h3>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">R_VERSION</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>4.4.1</span>
<span id="cb17-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">rstudio</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;</span></span></code></pre></div>
<hr>
</section>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>We’ve installed different versions of R and learned how to switch between them. This flexibility can help us experiment with different analyses and projects. The toggling shim is an excellent solution for launching RStudio with your preferred R version. However, I encountered an issue when opening R projects (.Rproj files). Regardless of the R version specified for the project, it always loads the latest installed version of R. Additionally, setting the <code>R_VERSION</code> environment variable does not affect which R version the project uses. This means that even if your project was created with an different version of R, it will still open with an unintended latest version in /opt/R.</p>
<p>A practical workaround I found is to launch RStudio with the desired R version first, then switch to the intended project using the toggle in the upper right corner. See green arrow below.</p>
<p><a href="images/Pasted image 20241111143836.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://www.bolaponte.com/blog/2024-11-11-flexible_r/images/Pasted image 20241111143836.png" class="img-fluid"></a></p>
<p>It’s not a frictionless solution but it’s not too bad once you’ve incorporated it in your workflow. For now, it will do. I’ll slowly make improvements to see if I can get it working with projects.</p>
<hr>
<p>I hope this helps out folks wanting to have various versions of R and easily switch between them. Please let me know if you have any comments of suggestions.</p>
</section>
<section id="additional-resources" class="level2">
<h2 class="anchored" data-anchor-id="additional-resources">Additional Resources</h2>
<section id="official-documentation" class="level3">
<h3 class="anchored" data-anchor-id="official-documentation">Official Documentation</h3>
<ul>
<li><p><a href="https://support.posit.co/hc/en-us/articles/215488098-Installing-multiple-versions-of-R-on-Linux">Installing Multiple Versions of R on Linux</a><br>
Comprehensive guide from Posit on how to install and manage multiple R versions on Linux systems.</p></li>
<li><p><a href="https://support.posit.co/hc/en-us/articles/200486138-Changing-R-versions-for-the-RStudio-Desktop-IDE">Changing R Versions for the RStudio Desktop IDE</a><br>
Instructions on how to switch between different R versions within the RStudio IDE.</p></li>
<li><p><a href="https://cran.rstudio.com/doc/manuals/r-devel/R-admin.html">R Administration Manual</a><br>
Official R documentation detailing configurations.</p></li>
</ul>
</section>
<section id="community-discussions" class="level3">
<h3 class="anchored" data-anchor-id="community-discussions">Community Discussions</h3>
<ul>
<li><p><a href="https://forum.posit.co/t/r-with-lapack-from-openblas/170554">R with LAPACK from OpenBLAS - Posit Forum</a><br>
A forum thread discussing the integration of LAPACK from OpenBLAS in R.</p></li>
<li><p><a href="https://brettklamer.com/diversions/statistical/faster-blas-in-r/">Faster BLAS in R - Brett Klamer’s Blog</a><br>
Blog post exploring methods to speed up BLAS operations in R.</p></li>
</ul>
</section>
<section id="tutorials-and-guides" class="level3">
<h3 class="anchored" data-anchor-id="tutorials-and-guides">Tutorials and Guides</h3>
<ul>
<li><p><a href="https://csantill.github.io/RPerformanceWBLAS/">R Performance with BLAS - csantill.github.io</a><br>
A detailed tutorial on optimizing R performance using BLAS libraries.</p></li>
<li><p><a href="https://www.r-bloggers.com/2017/11/why-is-r-slow-some-explanations-and-mklopenblas-setup-to-try-to-fix-this/">Why is R Slow? Explanations and MKL/OpenBLAS Setup to Fix It</a><br>
An R-bloggers article explaining common performance issues in R and how to address them with MKL/OpenBLAS.</p></li>
<li><p><a href="https://jeff.vtkellers.com/posts/data-science/managing-multiple-r-installations-on-linux/">Managing Multiple R Installations on Linux</a></p></li>
<li><p><a href="https://www.monicathieu.com/posts/2024-05-21-multiple-r-versions/">Monica Thieu’s Post on Managing Multiple R Versions</a><br>
Insights and solutions from the community on handling multiple R versions.</p></li>
</ul>
</section>
<section id="tools-and-repositories" class="level3">
<h3 class="anchored" data-anchor-id="tools-and-repositories">Tools and Repositories</h3>
<ul>
<li><a href="https://github.com/goepp/r-blas">r-blas GitHub Repository</a><br>
GitHub repository for managing BLAS configurations in R.</li>
</ul>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-aponte_rolón2024" class="csl-entry quarto-appendix-citeas">
Aponte Rolón, Bolívar. 2024. <span>“Flexible R Setup on Linux.”</span>
November 11, 2024. <a href="https://www.bolaponte.com/blog/2024-11-11-flexible_r/">https://www.bolaponte.com/blog/2024-11-11-flexible_r/</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>Linux</category>
  <category>OpenBLAS</category>
  <category>Computer Science</category>
  <guid>https://www.bolaponte.com/blog/2024-11-11-flexible_r/</guid>
  <pubDate>Mon, 11 Nov 2024 06:00:00 GMT</pubDate>
  <media:content url="https://www.bolaponte.com/blog/2024-11-11-flexible_r/featured.png" medium="image" type="image/png" height="67" width="144"/>
</item>
<item>
  <title>Loop Less, Do More: Iterating Efficiently with purrr</title>
  <dc:creator>Bolívar Aponte Rolón</dc:creator>
  <link>https://www.bolaponte.com/blog/2024-10-15-map_purrr/</link>
  <description><![CDATA[ 

<!-- source: https://github.com/gadenbuie/garrickadenbuie-com/blob/main/_partials/title-block-link-buttons/title-block.html -->
<!-- <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title"> 
-->
<!-- <header id="title-block-header" class="quarto-title-block default page-columns"> -->
<!-- <div class="quarto-title page-columns page-full featured-image p-4" style="background-image: url(featured.png), url(featured.jpg), url(../featured.jpg);"> -->



<p>For the past couple of years, I’ve been deepening my understanding of R—its ecosystem and the many tools it offers for supporting open and reproducible science. Lately, I’ve been participating in the <em>Programming in R</em> course by <a href="https://posit.co/products/enterprise/academy/">Posit Academy</a> and learning functional programming concepts, which I highly recommend even if you’re a seasoned useR. This has prompted me to refactor much of the code I’ve produce to be more maintainable and human. My main focus has been plot reproduction. Some of my code has hundreds of lines producing <em>ggplots</em> that can easily be turned into a function(s). This is where the <code>purrr</code> package comes in.</p>
<section id="what-have-i-learned" class="level2">
<h2 class="anchored" data-anchor-id="what-have-i-learned">What have I learned?</h2>
<p>Let’s see some example of how to use <code>purr::map()</code> to automate plot generation.</p>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gapminder)</span></code></pre></div>
</div>
<p>The <code>tidyverse</code> meta package includes <code>ggplot</code> (plots generation), <code>purrr</code> (iteration), and <code>dplyr</code> (data wrangling) the three main packages we will be using. ### The problem</p>
</section>
<section id="copy-and-paste-code-to-produce-plots." class="level3">
<h3 class="anchored" data-anchor-id="copy-and-paste-code-to-produce-plots.">Copy and paste code to produce plots.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Afghanistan</span></span>
<span id="cb2-2">gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Afghanistan"</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Afghanistan"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/copy_plots-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/copy_plots-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># United States</span></span>
<span id="cb3-2">gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/copy_plots-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/copy_plots-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># United Kingdom</span></span>
<span id="cb4-2">gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United Kingdom"</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United Kingdom"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/copy_plots-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/copy_plots-3.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># China</span></span>
<span id="cb5-2">gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"China"</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"China"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/copy_plots-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/copy_plots-4.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># India</span></span>
<span id="cb6-2">gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"India"</span> ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"India"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/copy_plots-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/copy_plots-5.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Five plots might not be a big deal. But it quickly becomes a hassle to keep track of when you have over a dozen variables and the plots are roughly the same that it’s not worth writing a whole new chunk. I’ve omitted creating respective object for the plots, but that is how I would usually store them and call them throughout the analysis (e.g., <code>us_scatter</code> or something like that). The issue with this approach is that it is prone to a lot of error. Copying and pasting, then tweaking the code ever so slightly is a major source of human error (e.g.&nbsp;forgetting to change the <code>x</code> variable). Again, its manageable now, but not with bigger projects.</p>
</section>
</section>
<section id="how-do-we-automate-this" class="level2">
<h2 class="anchored" data-anchor-id="how-do-we-automate-this">How do we automate this?</h2>
<p>First, let’s write a function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">lm_ggplot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(data, .country, x, y) {</span>
<span id="cb7-2">data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> {{.country}} ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> {{x}}, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> {{y}})) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_jitter</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se =</span> T, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> .country)</span>
<span id="cb7-8">}</span></code></pre></div>
</div>
<p>Let’s test our function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_ggplot</span>(gapminder, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Afghanistan"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/test_function-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/test_function-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>Great! Our function has the desired output and we can now use it to automate the plot generation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">countries <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Afghanistan"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United States"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"United Kingdom"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"China"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"India"</span>)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(countries, \(.x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm_ggplot</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> gapminder, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.country =</span> .x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> lifeExp))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/automate_plots-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/automate_plots-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/automate_plots-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/automate_plots-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/automate_plots-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/automate_plots-3.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[4]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/automate_plots-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/automate_plots-4.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[5]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/automate_plots-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/automate_plots-5.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>We are able to generate the sample plot for all countries with far fewer lines of code. We have effectively, iterated over the <code>countries</code> vector and applied the <code>lm_ggplot</code> function to each element. This is a simple example, but the power of <code>purrr</code> is that it can be used to iterate over any object that can be iterated over (e.g., lists, dataframes, etc.).</p>
</section>
<section id="how-does-map-work" class="level2">
<h2 class="anchored" data-anchor-id="how-does-map-work">How does <code>map()</code> work?</h2>
<p><code>map()</code> is a function that takes two arguments:</p>
<pre><code>map(v, .fun)</code></pre>
<p>a vector or list and a function. The function is applied to each element of the vector or list. It is specialized to iterate over and return vectors and lists.</p>
<p>The way I used <code>map()</code> here is with the syntax usually used for anonymous functions. The <code>\.x</code> is a shorthand for the first argument of the function. in this case, it is were the vectors of <code>countries</code> will be passed to to iterate over.</p>
</section>
<section id="behold-the-list-column" class="level2">
<h2 class="anchored" data-anchor-id="behold-the-list-column">Behold, the <em>list column</em></h2>
<p>When we work with R work are working with object that are atomic vectors of different types (e.g., character, numerical, integers, floats, etc.). One of the most powerful data structures in R are lists. Lists are a collection of objects that can be of any type. This makes them very flexible and powerful. We can have a list of data frames (which are list themselves), plots, functions, etc. In this exercise, <code>map()</code> returned a list of <code>ggplots</code>. Now one of the most useful things I have learned lately is the <code>list columns</code>.</p>
<p>List columns are a column in a data frame that contains a list. This is allows us to store multiple objects in a single column. Having a list column within a data frame or by it self can help us reduce the number of intermediate object that we create within a project. Instead of creating an object for each plot or linear models, we can store them in a list column in a single object that we can access and use throughout our analyses.</p>
<p>Let’s see how lists columns work. We are going to use <code>nest()</code> to summarize grouped data by nesting the non-grouping variables into a list column of data frames—one data frame per group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">life_expectancy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span id="cb21-2">  gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(country, continent, year, lifeExp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, continent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>()</span>
<span id="cb21-6"></span>
<span id="cb21-7">life_expectancy</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 3
# Groups:   country, continent [142]
   country     continent data             
   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
 1 Afghanistan Asia      &lt;tibble [12 × 2]&gt;
 2 Albania     Europe    &lt;tibble [12 × 2]&gt;
 3 Algeria     Africa    &lt;tibble [12 × 2]&gt;
 4 Angola      Africa    &lt;tibble [12 × 2]&gt;
 5 Argentina   Americas  &lt;tibble [12 × 2]&gt;
 6 Australia   Oceania   &lt;tibble [12 × 2]&gt;
 7 Austria     Europe    &lt;tibble [12 × 2]&gt;
 8 Bahrain     Asia      &lt;tibble [12 × 2]&gt;
 9 Bangladesh  Asia      &lt;tibble [12 × 2]&gt;
10 Belgium     Europe    &lt;tibble [12 × 2]&gt;
# ℹ 132 more rows</code></pre>
</div>
</div>
<p>Now we have a data frame with column <code>data</code> that contains a list of data frames. We can use <code>map()</code> to apply a function to each element of the list column.</p>
<p>Let’s define some useful functions to fit a linear model, plot the data, and predict life expectancy in 2030.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions to fit a linear model, plot the data, and predict life expectancy in 2030</span></span>
<span id="cb23-2">fit_pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df) {</span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> df)</span>
<span id="cb23-4">}</span>
<span id="cb23-5"></span>
<span id="cb23-6">plot_pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(df) {</span>
<span id="cb23-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> pop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb23-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_smooth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> lm)</span>
<span id="cb23-10">}</span>
<span id="cb23-11"></span>
<span id="cb23-12">pred_pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(mod) {</span>
<span id="cb23-13">  input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2030</span>)</span>
<span id="cb23-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> input)</span>
<span id="cb23-15">}</span></code></pre></div>
</div>
<p>Now we can use <code>map()</code> to apply these functions to each data frame in the list column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit a linear model to each data frame in the list column</span></span>
<span id="cb24-2">gap_list_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gapminder <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(country, year, pop) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nest</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb24-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, fit_pop),</span>
<span id="cb24-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(data, plot_pop),</span>
<span id="cb24-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop_2030 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(model, pred_pop)</span>
<span id="cb24-10">  )</span>
<span id="cb24-11"></span>
<span id="cb24-12">gap_list_df</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 142 × 5
# Groups:   country [142]
   country     data              model  plot     pop_2030
   &lt;fct&gt;       &lt;list&gt;            &lt;list&gt; &lt;list&gt;      &lt;dbl&gt;
 1 Afghanistan &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    33846451.
 2 Albania     &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;     4879306.
 3 Algeria     &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    43758285.
 4 Angola      &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    14598072.
 5 Argentina   &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    49706374.
 6 Australia   &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    25613532.
 7 Austria     &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;     8784507.
 8 Bahrain     &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;      956764.
 9 Bangladesh  &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;   187136396.
10 Belgium     &lt;tibble [12 × 2]&gt; &lt;lm&gt;   &lt;gg&gt;    11138373.
# ℹ 132 more rows</code></pre>
</div>
</div>
<p>For each country we have a group data frame within <code>data</code> column, a linear model in <code>model</code> column, and a ggplot in <code>plot</code> column. We can access it like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Afghanistan data frame</span></span>
<span id="cb26-2">gap_list_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 2
    year      pop
   &lt;int&gt;    &lt;int&gt;
 1  1952  8425333
 2  1957  9240934
 3  1962 10267083
 4  1967 11537966
 5  1972 13079460
 6  1977 14880372
 7  1982 12881816
 8  1987 13867957
 9  1992 16317921
10  1997 22227415
11  2002 25268405
12  2007 31889923</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Afghanistan linear model</span></span>
<span id="cb28-2">gap_list_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>model[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = pop ~ year, data = df)

Coefficients:
(Intercept)         year  
 -690631821       356886  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Afghanistan ggplot</span></span>
<span id="cb30-2">gap_list_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>plot[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/access_list_column-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="https://www.bolaponte.com/blog/2024-10-15-map_purrr/index_files/figure-html/access_list_column-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Afghanistan predicted population in 2030</span></span>
<span id="cb32-2">gap_list_df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pop_2030[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 33846451</code></pre>
</div>
</div>
<p>With one object we can access all the information we need for each country. We can include this in reports and analyses.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>These are some of the ways I’ve been using <code>purrr</code> to automate my plots and analyses. I hope you find this useful and that it helps you in your work. I highly recommend you check out the <a href="https://r4ds.had.co.nz/">R for Data Science</a> book by Hadley Wickham and Garrett Grolemund. It is a great resource for learning the <code>tidyverse</code> and <code>purrr</code>.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://r4ds.had.co.nz/">R for Data Science</a></li>
<li><a href="https://cran.r-project.org/web/packages/gapminder/vignettes/gapminder.html">Gapminder vignette</a></li>
<li><a href="https://github.com/jennybc/code-smells-and-feels">Code Smells and Feels</a></li>
<li><a href="https://www.cedricscherer.com/2023/07/05/efficiency-and-consistency-automate-subset-graphics-with-ggplot2-and-purrr/">Efficiency and Consistency: Automate Subset Graphics with ggplot2 and purrr</a></li>
</ul>


</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-aponte_rolón2024" class="csl-entry quarto-appendix-citeas">
Aponte Rolón, Bolívar. 2024. <span>“Loop Less, Do More: Iterating
Efficiently with `Purrr`.”</span> October 21, 2024. <a href="https://www.bolaponte.com/blog/2024-10-15-map_purrr/">https://www.bolaponte.com/blog/2024-10-15-map_purrr/</a>.
</div></div></section></div> ]]></description>
  <category>R</category>
  <category>tidyverse</category>
  <category>purrr</category>
  <guid>https://www.bolaponte.com/blog/2024-10-15-map_purrr/</guid>
  <pubDate>Mon, 21 Oct 2024 05:00:00 GMT</pubDate>
  <media:content url="https://www.bolaponte.com/blog/2024-10-15-map_purrr/apple-touch-icon-152x152.png" medium="image" type="image/png" height="144" width="144"/>
</item>
</channel>
</rss>
